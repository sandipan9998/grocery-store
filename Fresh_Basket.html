<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreshBasket - Online Grocery Delivery</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2ecc71;
            --primary-dark: #27ae60;
            --secondary: #3498db;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --danger: #e74c3c;
            --warning: #f39c12;
            --gray: #95a5a6;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Auth Pages */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.9) 0%, rgba(52, 152, 219, 0.9) 100%), 
                        url('https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80') center center / cover;
            padding: 20px;
        }

        .auth-form {
            background: var(--white);
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 30px;
            width: 100%;
            max-width: 450px;
            position: relative; 
            z-index: 2;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .auth-header-logo {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .auth-header h2 {
            color: var(--dark);
            margin: 0;
            font-size: 24px;
        }

        .auth-header p {
            color: var(--gray);
            margin-top: 5px;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .blinking-logo-icon {
            font-size: 28px;
            color: var(--primary);
            animation: blink 1.5s infinite alternate;
        }
        
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(46, 204, 113, 0.2);
        }

        .btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 12px 30px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
            font-size: 16px;
        }

        .btn:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-secondary:hover {
            background: #2980b9;
        }

        .auth-footer {
            text-align: center;
            margin-top: 20px;
        }

        .auth-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fee;
            color: var(--danger);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .success-message {
            background: #efe;
            color: var(--primary-dark);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        /* Main App */
        .app-container {
            display: none;
        }

        /* Header Styles */
        header {
            background-color: var(--white);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .logo i {
            font-size: 28px;
        }

        .search-bar {
            flex: 1;
            max-width: 500px;
            margin: 0 20px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 20px;
            border-radius: 30px;
            border: 1px solid var(--gray);
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        .search-bar input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(46, 204, 113, 0.2);
        }

        .search-bar button {
            position: absolute;
            right: 5px;
            top: 5px;
            background: var(--primary);
            border: none;
            color: white;
            padding: 7px 15px;
            border-radius: 30px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .search-bar button:hover {
            background: var(--primary-dark);
        }

        .user-actions {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .user-actions a {
            color: var(--dark);
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
            transition: color 0.3s;
        }

        .user-actions a:hover {
            color: var(--primary);
        }

        .user-actions i {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .cart-count {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            position: absolute;
            top: -5px;
            right: -5px;
        }

        .cart-icon {
            position: relative;
        }

        nav {
            background: var(--dark);
            padding: 10px 0;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 25px;
        }

        .nav-links a {
            color: var(--white);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        /* Hero Section */
        @keyframes slideBackground {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 100% 50%;
            }
        }
        
        .hero {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1589985270826-4b7bb135bc9d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80');
            background-size: 150% auto;
            background-position: center;
            color: white;
            padding: 80px 0;
            text-align: center;
            transition: background-image 1s ease-in-out; 
            animation: slideBackground 25s linear infinite alternate;
        }

        .hero h1 {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .hero p {
            font-size: 20px;
            max-width: 700px;
            margin: 0 auto 30px;
        }

        /* Categories */
        .section-title {
            text-align: center;
            margin: 40px 0 20px;
            font-size: 32px;
            color: var(--dark);
        }

        .categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .category {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .category:hover {
            transform: translateY(-5px);
        }

        .category i {
            font-size: 30px;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .category h3 {
            font-size: 16px;
            color: var(--dark);
        }

        /* Products */
        .products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .product {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }

        .product:hover {
            transform: translateY(-5px);
        }

        .product-img {
            height: 180px;
            background-size: cover;
            background-position: center;
        }

        .product-info {
            padding: 15px;
        }

        .product-title {
            font-size: 18px;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .product-price {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .product-price::before {
            content: "₹";
        }

        .product-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quantity {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid var(--gray);
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity span {
            font-weight: 600;
        }

        .add-to-cart {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .add-to-cart:hover {
            background: var(--primary-dark);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 800px;
            border-radius: 10px;
            padding: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        .cart-items {
            margin-bottom: 20px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .cart-item-img {
            width: 80px;
            height: 80px;
            background-size: cover;
            background-position: center;
            border-radius: 5px;
            margin-right: 15px;
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .cart-item-price {
            color: var(--primary);
            font-weight: 700;
        }

        .cart-item-price::before {
            content: "₹";
        }

        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .remove-item {
            color: var(--danger);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
        }

        .cart-summary {
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .delivery-estimate {
            background: #e6f7ff; 
            border: 1px solid var(--secondary);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px; 
            font-weight: 700;
            color: var(--secondary);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .delivery-estimate i {
            color: var(--secondary);
            font-size: 20px;
        }
        
        /* New styles for slot selection */
        .slot-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .slot-day-item, .slot-time-item {
            border: 2px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-weight: 600;
            color: var(--dark);
            position: relative;
        }
        
        .slot-day-item:hover, .slot-time-item:hover {
            border-color: var(--warning);
        }

        .slot-day-item.selected, .slot-time-item.selected {
            border-color: var(--primary);
            background: rgba(46, 204, 113, 0.1);
            color: var(--primary-dark);
        }

        .slot-day-item.disabled, .slot-time-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f1f1f1;
            border-color: #eee;
        }
        /* End new styles */


        .summary-total {
            font-weight: 700;
            font-size: 20px;
            color: var(--dark);
        }

        .checkout-btn {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            font-size: 18px;
        }

        /* Checkout Form */
        .checkout-form {
            margin-top: 20px;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .payment-method {
            border: 2px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-method:hover {
            border-color: var(--primary);
        }

        .payment-method.selected {
            border-color: var(--primary);
            background: rgba(46, 204, 113, 0.1);
        }

        .upi-app {
            border: 2px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .upi-app:hover {
            border-color: var(--warning);
            transform: translateY(-3px);
        }

        .upi-app.selected {
            border-color: var(--warning);
            background: rgba(243, 156, 18, 0.1);
        }

        /* Order History */
        .order-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .order-id {
            font-weight: 700;
            color: var(--dark);
        }

        .order-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-delivered {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .order-delivery-time {
            font-size: 14px;
            color: var(--primary-dark);
            font-weight: 600;
            margin-top: 5px;
        }

        .order-items {
            margin: 15px 0;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .download-invoice-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .download-invoice-btn:hover {
            background: #2980b9;
        }

        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 160px;
            box-shadow: var(--shadow);
            border-radius: 5px;
            z-index: 1;
            overflow: hidden;
        }

        .dropdown-content a {
            color: var(--dark);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background 0.3s;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        /* Footer */
        footer {
            background: var(--dark);
            color: white;
            padding: 50px 0 20px;
            margin-top: 50px;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .footer-column h3 {
            font-size: 18px;
            margin-bottom: 20px;
            position: relative;
            padding-bottom: 10px;
        }

        .footer-column h3::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 40px;
            height: 2px;
            background: var(--primary);
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 10px;
        }

        .footer-links a {
            color: var(--light);
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: var(--primary);
        }

        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .social-links a {
            color: white;
            font-size: 20px;
            transition: color 0.3s;
        }

        .social-links a:hover {
            color: var(--primary);
        }

        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                gap: 15px;
            }

            .search-bar {
                margin: 10px 0;
                max-width: 100%;
            }

            .nav-links {
                overflow-x: auto;
                padding-bottom: 10px;
            }

            .hero h1 {
                font-size: 36px;
            }

            .hero p {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="auth-container" id="login-page">
        <div class="auth-form">
            <div class="auth-header">
                <div class="auth-header-content">
                    <h2 style="margin-right: auto;">Welcome Back</h2>
                    <div class="auth-header-logo">
                        <i class="fas fa-shopping-basket blinking-logo-icon"></i>
                        <span>FreshBasket</span>
                    </div>
                </div>
                <p>Sign in to your account</p>
            </div>
            <div class="error-message" id="login-error"></div>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email">Email Address</label>
                    <input type="email" id="login-email" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" class="form-control" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn">Sign In</button>
            </form>
            <div class="auth-footer">
                <p>Don't have an account? <a href="#" id="show-register">Create one here</a></p>
            </div>
        </div>
    </div>

    <div class="auth-container" id="register-page" style="display: none;">
        <div class="auth-form">
            <div class="auth-header">
                <h2>Create Account</h2>
                <p>Sign up for a new account</p>
            </div>
            <div class="error-message" id="register-error"></div>
            <div class="success-message" id="register-success"></div>
            <form id="register-form">
                <div class="form-group">
                    <label for="register-name">Full Name</label>
                    <input type="text" id="register-name" class="form-control" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="register-email">Email Address</label>
                    <input type="email" id="register-email" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="register-phone">Phone Number</label>
                    <input type="tel" id="register-phone" class="form-control" placeholder="Enter your phone number" required>
                </div>
                <div class="form-group">
                    <label for="register-address">Delivery Address</label>
                    <textarea id="register-address" class="form-control" placeholder="Enter your delivery address" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" class="form-control" placeholder="Create a password (min 6 characters)" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="register-confirm-password">Confirm Password</label>
                    <input type="password" id="register-confirm-password" class="form-control" placeholder="Confirm your password" required>
                </div>
                <button type="submit" class="btn">Create Account</button>
            </form>
            <div class="auth-footer">
                <p>Already have an account? <a href="#" id="show-login">Sign in here</a></p>
            </div>
        </div>
    </div>

    <div class="app-container" id="app-container">
        <header>
            <div class="container">
                <div class="header-top">
                    <div class="logo">
                        <i class="fas fa-shopping-basket"></i>
                        <span>FreshBasket</span>
                    </div>
                    <div class="search-bar">
                        <input type="text" placeholder="Search for products..." id="search-input">
                        <button id="search-button"><i class="fas fa-search"></i></button>
                    </div>
                    <div class="user-actions">
                        <div class="dropdown">
                            <div class="user-profile">
                                <img src="https://ui-avatars.com/api/?name=User&background=2ecc71&color=fff" alt="User" id="user-avatar">
                                <span id="user-name">User</span>
                            </div>
                            <div class="dropdown-content">
                                <a href="#" id="my-profile"><i class="fas fa-user"></i> My Profile</a>
                                <a href="#" id="order-history-link"><i class="fas fa-history"></i> Order History</a>
                                <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                            </div>
                        </div>
                        <a href="#" class="cart-icon" id="cart-icon">
                            <i class="fas fa-shopping-cart"></i>
                            <span>Cart</span>
                            <span class="cart-count">0</span>
                        </a>
                    </div>
                </div>
            </div>
            <nav>
                <div class="container">
                    <ul class="nav-links">
                        <li><a href="#" id="home-link">Home</a></li>
                        <li><a href="#">Fruits & Vegetables</a></li>
                        <li><a href="#">Dairy & Eggs</a></li>
                        <li><a href="#">Meat & Seafood</a></li>
                        <li><a href="#">Bakery</a></li>
                        <li><a href="#">Beverages</a></li>
                        <li><a href="#">Snacks</a></li>
                        <li><a href="#">Household</a></li>
                    </ul>
                </div>
            </nav>
        </header>

        <div id="home-view">
            <section class="hero" id="hero-section">
                <div class="container">
                    <h1>Fresh Groceries Delivered to Your Door</h1>
                    <p>Shop from a wide selection of fresh produce, pantry staples, and household essentials with fast, reliable delivery.</p>
                    <a href="#products-section" class="btn">Shop Now</a>
                </div>
            </section>

            <section class="container">
                <h2 class="section-title">Shop by Category</h2>
                <div class="categories">
                    <div class="category">
                        <i class="fas fa-apple-alt"></i>
                        <h3>Fruits & Vegetables</h3>
                    </div>
                    <div class="category">
                        <i class="fas fa-cheese"></i>
                        <h3>Dairy & Eggs</h3>
                    </div>
                    <div class="category">
                        <i class="fas fa-drumstick-bite"></i>
                        <h3>Meat & Seafood</h3>
                    </div>
                    <div class="category">
                        <i class="fas fa-bread-slice"></i>
                        <h3>Bakery</h3>
                    </div>
                    <div class="category">
                        <i class="fas fa-wine-bottle"></i>
                        <h3>Beverages</h3>
                    </div>
                    <div class="category">
                        <i class="fas fa-cookie"></i>
                        <h3>Snacks</h3>
                    </div>
                    <div class="category">
                        <i class="fas fa-pump-soap"></i>
                        <h3>Household</h3>
                    </div>
                    <div class="category">
                        <i class="fas fa-baby"></i>
                        <h3>Baby Care</h3>
                    </div>
                </div>
            </section>

            <section class="container" id="products-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title" style="margin: 0;">Featured Products</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <label for="category-filter" style="font-weight: 600;">Filter by Category:</label>
                        <select id="category-filter" class="form-control" style="width: auto; padding: 8px 15px;">
                            <option value="all">All Categories</option>
                            <option value="Fruits & Vegetables">Fruits & Vegetables</option>
                            <option value="Dairy & Eggs">Dairy & Eggs</option>
                            <option value="Bakery">Bakery</option>
                            <option value="Beverages">Beverages</option>
                            <option value="Snacks">Snacks</option>
                            <option value="Meat & Seafood">Meat & Seafood</option>
                            <option value="Staples">Staples</option>
                            <option value="Personal Care">Personal Care</option>
                            <option value="Household">Household</option>
                        </select>
                    </div>
                </div>
                <div class="products" id="products-container">
                </div>
            </section>
        </div>

        <div id="order-history-view" style="display: none;">
            <section class="container">
                <h2 class="section-title">Order History</h2>
                <div id="orders-container">
                </div>
            </section>
        </div>

        <div id="profile-view" style="display: none;">
            <section class="container">
                <h2 class="section-title">My Profile</h2>
                <div class="order-card">
                    <h3 style="margin-bottom: 20px;">Personal Information</h3>
                    <form id="profile-form">
                        <div class="form-group">
                            <label for="profile-name">Full Name</label>
                            <input type="text" id="profile-name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="profile-email">Email Address</label>
                            <input type="email" id="profile-email" class="form-control" readonly style="background-color: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label for="profile-phone">Phone Number</label>
                            <input type="tel" id="profile-phone" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="profile-address">Delivery Address</label>
                            <textarea id="profile-address" class="form-control" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn" style="width: auto; margin-right: 10px;">Update Profile</button>
                        <button type="button" class="btn btn-secondary" id="change-password-btn" style="width: auto; background: var(--warning);">Change Password</button>
                    </form>

                    <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #fee;">
                        <h3 style="color: var(--danger); margin-bottom: 15px;">Danger Zone</h3>
                        <p style="color: var(--gray); margin-bottom: 15px;">Once you delete your account, there is no going back. All your orders and data will be permanently deleted.</p>
                        <button class="btn" id="delete-account-btn" style="background: var(--danger); width: auto;">Delete Account</button>
                    </div>
                </div>
            </section>
        </div>

        <div class="modal" id="cart-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Your Shopping Cart</h2>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="cart-items" id="cart-items">
                </div>
                <div class="cart-summary">
                    <!-- Delivery Estimate in Cart Modal (fixed display)-->
                    <div class="delivery-estimate">
                        <i class="fas fa-shipping-fast"></i> **Choose a Slot at Checkout for Delivery Time**
                    </div>
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">₹0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Delivery Fee:</span>
                        <span id="delivery-fee">₹40.00</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span>Total:</span>
                        <span id="total">₹40.00</span>
                    </div>
                    <button class="btn checkout-btn" id="proceed-checkout-btn">Proceed to Checkout</button>
                </div>
            </div>
        </div>

        <div class="modal" id="checkout-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Checkout</h2>
                    <button class="close-modal" id="close-checkout-modal">&times;</button>
                </div>
                <div class="checkout-form">
                    
                    <!-- NEW: Delivery Slot Selection Section -->
                    <h3 style="margin-top: 0;">1. Select Delivery Slot</h3>
                    <p style="font-size: 14px; color: var(--gray); margin-bottom: 15px;">Your order will be delivered within 10 minutes of the selected time slot start.</p>
                    
                    <div class="form-group">
                        <label>Delivery Day (Up to 7 days)</label>
                        <div class="slot-selection-grid" id="day-slots-container">
                            <!-- Day slots will be generated here -->
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 30px;">
                        <label>Delivery Time Slot</label>
                        <div class="slot-selection-grid" id="time-slots-container">
                            <!-- Time slots will be generated here -->
                        </div>
                        <div class="error-message" id="delivery-slot-error" style="margin-top: 10px;">Please select a delivery day and time slot.</div>
                    </div>
                    <!-- END NEW -->

                    <h3>2. Delivery Address</h3>
                    <div class="order-card" id="checkout-address-card">
                        <p id="checkout-name"></p>
                        <p id="checkout-phone"></p>
                        <p id="checkout-address"></p>
                        <button class="btn btn-secondary" style="width: auto; margin-top: 10px; padding: 5px 10px;" id="edit-address-btn">Edit Address</button>
                    </div>

                    <h3 style="margin-top: 20px;">3. Select Payment Method</h3>
                    <div class="payment-methods">
                        <div class="payment-method" data-method="cod">
                            <i class="fas fa-money-bill-wave" style="font-size: 24px; color: var(--primary);"></i>
                            <p style="margin-top: 5px; font-weight: 600;">Cash on Delivery</p>
                        </div>
                        <div class="payment-method" data-method="card">
                            <i class="fas fa-credit-card" style="font-size: 24px; color: var(--secondary);"></i>
                            <p style="margin-top: 5px; font-weight: 600;">Credit/Debit Card</p>
                        </div>
                        <div class="payment-method" data-method="upi">
                            <i class="fas fa-mobile-alt" style="font-size: 24px; color: var(--warning);"></i>
                            <p style="margin-top: 5px; font-weight: 600;">UPI / Netbanking</p>
                        </div>
                    </div>

                    <div id="card-payment-details" style="display: none; background: #fff5e6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px;">Card Details</h4>
                        <div class="form-group">
                            <label for="card-number">Card Number</label>
                            <input type="text" id="card-number" class="form-control" placeholder="**** **** **** ****" maxlength="19">
                        </div>
                        <div class="form-group">
                            <label for="card-name">Cardholder Name</label>
                            <input type="text" id="card-name" class="form-control" placeholder="Name on card">
                        </div>
                        <div style="display: flex; gap: 20px;">
                            <div class="form-group" style="flex: 1;">
                                <label for="card-expiry">Expiry Date (MM/YY)</label>
                                <input type="text" id="card-expiry" class="form-control" placeholder="MM/YY" maxlength="5">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="card-cvv">CVV</label>
                                <input type="password" id="card-cvv" class="form-control" placeholder="***" maxlength="3">
                            </div>
                        </div>
                    </div>

                    <div id="upi-payment-details" style="display: none; background: #eff9e6; padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 15px;">Select UPI App</h4>
                        <div class="upi-apps" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div class="upi-app" data-app="gpay">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/f/f2/Google_Pay_Logo.svg" alt="Google Pay" style="width: 100%; max-width: 80px; margin: 0 auto; display: block;">
                                <p style="text-align: center; margin-top: 8px; font-size: 14px;">Google Pay</p>
                            </div>
                            <div class="upi-app" data-app="paytm">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/2/24/Paytm_Logo_%28standalone%29.svg" alt="Paytm" style="width: 100%; max-width: 80px; margin: 0 auto; display: block;">
                                <p style="text-align: center; margin-top: 8px; font-size: 14px;">Paytm</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="upi-id">Or Enter UPI ID</label>
                            <input type="text" id="upi-id" class="form-control" placeholder="username@upi" required>
                        </div>
                    </div>

                    <div class="cart-summary">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="checkout-subtotal">₹0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Delivery Fee:</span>
                            <span id="checkout-delivery">₹40.00</span>
                        </div>
                        <div class="summary-row summary-total">
                            <span>Total:</span>
                            <span id="checkout-total">₹40.00</span>
                        </div>
                        <button class="btn checkout-btn" id="place-order-btn">Place Order</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal" id="password-modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Change Password</h2>
                    <button class="close-modal" id="close-password-modal">&times;</button>
                </div>
                <div class="error-message" id="password-error"></div>
                <div class="success-message" id="password-success"></div>
                <form id="change-password-form">
                    <div class="form-group">
                        <label for="current-password">Current Password</label>
                        <input type="password" id="current-password" class="form-control" placeholder="Enter current password" required>
                    </div>
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" class="form-control" placeholder="Enter new password (min 6 characters)" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="confirm-new-password">Confirm New Password</label>
                        <input type="password" id="confirm-new-password" class="form-control" placeholder="Confirm new password" required>
                    </div>
                    <button type="submit" class="btn">Change Password</button>
                </form>
            </div>
        </div>

    </div>

    <footer>
        <div class="container footer-content">
            <div class="footer-column">
                <div class="logo" style="margin-bottom: 20px;">
                    <i class="fas fa-shopping-basket"></i>
                    <span>FreshBasket</span>
                </div>
                <p style="color: var(--light); font-size: 14px;">Your one-stop destination for fresh groceries delivered right to your doorstep.</p>
            </div>
            <div class="footer-column">
                <h3>Quick Links</h3>
                <ul class="footer-links">
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Contact for any query : supportfreshbasket@gmail.com</a></li>
                    <li><a href="#">FAQs</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Terms of Service</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Categories</h3>
                <ul class="footer-links">
                    <li><a href="#">Fruits & Vegetables</a></li>
                    <li><a href="#">Dairy & Eggs</a></li>
                    <li><a href="#">Meat & Seafood</a></li>
                    <li><a href="#">Beverages</a></li>
                    <li><a href="#">Snacks</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Stay Connected</h3>
                <p style="color: var(--light); margin-bottom: 15px; font-size: 14px;">Follow us on social media for latest updates and offers.</p>
                <div class="social-links">
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
        </div>
        <div class="container footer-bottom">
            <p>&copy; 2025 FreshBasket. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Data structure
        let currentUser = null;
        let cart = [];
        let selectedPaymentMethod = null;
        let selectedUpiApp = null;
        let currentCategory = 'all';
        let selectedDeliveryDate = null; // New state variable
        let selectedTimeSlot = null;     // New state variable

        const timeSlots = [
            { id: 'morning', name: 'Morning', time: '9:00 AM - 12:00 PM', startHour: 9, endHour: 12 },
            { id: 'afternoon', name: 'Afternoon', time: '12:00 PM - 4:00 PM', startHour: 12, endHour: 16 },
            { id: 'evening', name: 'Evening', time: '4:00 PM - 8:00 PM', startHour: 16, endHour: 20 }
        ];

        const heroImages = [
            'https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80',
            'https://images.unsplash.com/photo-1589985270826-4b7bb135bc9d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80',
            'https://images.unsplash.com/photo-1550989460-0adf9ea622e2?auto=format&fit=crop&w=1200&q=80',
                                                                                                         
        ];
        let currentHeroImageIndex = 0;

        const products = [
            // Fruits & Vegetables
            { id: 1, name: "Fresh Apples (500g)", price: 55, image: "https://images.unsplash.com/photo-1568702846914-96b305d2aaeb?auto=format&fit=crop&w=400&q=80", category: "Fruits & Vegetables", brand: "Fresh Farm" },
            { id: 2, name: "Organic Bananas", price: 49, image: "https://images.unsplash.com/photo-1571771894821-ce9b6c11b08e?auto=format&fit=crop&w=400&q=80", category: "Fruits & Vegetables", brand: "Organic India" },
            { id: 3, name: "Fresh Tomatoes (1kg)", price: 60, image: "https://images-prod.healthline.com/hlcmsresource/images/AN_images/tomatoes-1296x728-feature.jpg", category: "Fruits & Vegetables", brand: "Fresh Farm" },
            { id: 4, name: "Green Capsicum", price: 40, image: "https://images.unsplash.com/photo-1563565375-f3fdfdbefa83?auto=format&fit=crop&w=400&q=80", category: "Fruits & Vegetables", brand: "Fresh Farm" },
            { id: 5, name: "Fresh Spinach", price: 30, image: "https://images.unsplash.com/photo-1576045057995-568f588f82fb?auto=format&fit=crop&w=400&q=80", category: "Fruits & Vegetables", brand: "Organic India" },
            
            // Dairy & Eggs
            { id: 6, name: "Amul Taaza Milk (500 ML)", price: 35, image: "https://5.imimg.com/data5/SELLER/Default/2022/11/OX/FS/VL/46081969/amul-toned-milk-1000x1000.jpg", category: "Dairy & Eggs", brand: "Amul" },
            { id: 7, name: "Mother Dairy Misti Doi (400g)", price: 50, image: "https://images-na.ssl-images-amazon.com/images/I/71-%2BEt7TKJL._SX522_.jpg", category: "Dairy & Eggs", brand: "Mother Dairy" },
            { id: 8, name: "Amul Butter (100g)", price: 56, image: "https://www.komalasvegemart.com/media/catalog/product/cache/1/image/9df78eab33525d08d6e5fb8d27136e95/1/5/15-8.jpg", category: "Dairy & Eggs", brand: "Amul" },
            { id: 9, name: "Farm Fresh Eggs (12 pcs)", price: 90, image: "https://images.unsplash.com/photo-1582722872445-44dc5f7e3c8f?auto=format&fit=crop&w=400&q=80", category: "Dairy & Eggs", brand: "Keggs" },
            { id: 10, name: "Amul Cheese Slices (200g)", price: 125, image: "https://m.media-amazon.com/images/I/712bKhX1zfL._SL1500_.jpg", category: "Dairy & Eggs", brand: "Amul" },
            
            // Bakery
            { id: 11, name: "Britannia Bread (400g)", price: 45, image: "https://m.media-amazon.com/images/I/81Snl26yAtL._SL1500_.jpg", category: "Bakery", brand: "Britannia" },
            { id: 12, name: "Bisk Farm Biscuits-Googly", price: 55, image: "https://res.retailershakti.com/incom/images/product/Bisk-Farm-Googly-Biscuits-1636607221-10092732-1.jpg", category: "Bakery", brand: "Bisk Farm" },
            { id: 13, name: "Monginis Almond Cookies", price: 80, image: "https://m.media-amazon.com/images/I/61NTS-X0C7L._SL1198_.jpg", category: "Bakery", brand: "Monginis" },
            
            // Beverages
            { id: 14, name: "Real Fruit Juice (1L)", price: 120, image: "https://shopatcloves.com/wp-content/uploads/2022/08/FE245006-CC20-4961-9C57-B32BCEC1CC40.jpeg", category: "Beverages", brand: "Real" },
            { id: 15, name: "Coca Cola (2L)", price: 90, image: "https://hip2save.com/wp-content/uploads/2016/12/untitled-53.jpg", category: "Beverages", brand: "Coca Cola" },
            { id: 16, name: "Bisleri Water (1L)", price: 20, image: "https://5.imimg.com/data5/SELLER/Default/2024/2/388306655/WN/PI/RP/32618623/bisleri-250-ml-2-1000x1000.png", category: "Beverages", brand: "Bisleri" },
            { id: 17, name: "Tata Tea Gold (500g)", price: 275, image: "https://m.media-amazon.com/images/I/61JuJcnZc3L._SL1199_.jpg", category: "Beverages", brand: "Tata Tea" },
            { id: 18, name: "Nescafe Coffee (200g)", price: 785, image: "https://i5.walmartimages.com/seo/Nescaf-Cl-sico-Instant-Coffee-Dark-Roast-1-Jar-7-Oz_b1367b76-22ba-45e1-a7d6-f3907fbf66be.53de3d3f340faacd28a784a11cfaef00.jpeg", category: "Beverages", brand: "Nescafe" },
            
            // Snacks
            { id: 19, name: "Lays Chips (90g)", price: 30, image: "https://i5.walmartimages.com/asr/fab05394-7ef1-4653-aab5-0a5d087264ea.8f48bf68fd77ed12bd2236011234bd6c.jpeg", category: "Snacks", brand: "Lays" },
            { id: 20, name: "Haldiram Namkeen (200g)", price: 65, image: "https://m.media-amazon.com/images/I/91uZkhNT7mL.jpg", category: "Snacks", brand: "Haldiram's" },
            { id: 21, name: "Parle-G Biscuits (800g)", price: 75, image: "https://m.media-amazon.com/images/I/61kZskdmJzL._SL1000_.jpg", category: "Snacks", brand: "Parle" },
            { id: 22, name: "Britannia Good Day (600g)", price: 95, image: "https://m.media-amazon.com/images/S/aplus-media/vc/d035a208-fdba-4426-80b6-8857fe238826.__CR0,0,970,600_PT0_SX970_V1___.jpg", category: "Snacks", brand: "Britannia" },
            { id: 23, name: "Kurkure (90g)", price: 30, image: "https://m.media-amazon.com/images/I/81NT2IUh9kL._SL1024_.jpg", category: "Snacks", brand: "Kurkure" },
            
            // Meat & Seafood
            { id: 24, name: "Fresh Chicken Breast (500g)", price: 175, image: "https://images.unsplash.com/photo-1604503468506-a8da13d82791?auto=format&fit=crop&w=400&q=80", category: "Meat & Seafood", brand: "Licious" },
            { id: 25, name: "Fresh Fish (500g)", price: 250, image: "http://fishsubsidy.org/wp-content/uploads/2020/02/Capture14-1.png", category: "Meat & Seafood", brand: "FreshToHome" },
            { id: 26, name: "Mutton (500g)", price: 450, image: "https://images.unsplash.com/photo-1607623814075-e51df1bdc82f?auto=format&fit=crop&w=400&q=80", category: "Meat & Seafood", brand: "Licious" },
            
            // Staples
            { id: 27, name: "India Gate Basmati Rice (5kg)", price: 475, image: "https://m.media-amazon.com/images/I/91MZComV1xL.jpg", category: "Staples", brand: "India Gate" },
            { id: 28, name: "Tata Salt (1kg)", price: 25, image: "https://m.media-amazon.com/images/I/614mm2hYHyL._SL1000_.jpg", category: "Staples", brand: "Tata" },
            { id: 29, name: "Fortune Sunflower Oil (1L)", price: 185, image: "https://m.media-amazon.com/images/I/412TbDp8+mL.jpg", category: "Staples", brand: "Fortune" },
            { id: 30, name: "Tata Sampann Atta (10kg)", price: 450, image: "https://www.tatanutrikorner.com/cdn/shop/files/TS_Millet_Simulation_FOP.jpg?v=1716451683", category: "Staples", brand: "Tata Sampann" },
            { id: 31, name: "Fortune Arhar Dal (500g)", price: 140, image: "https://m.media-amazon.com/images/I/615QxZjTJfL._SX569_.jpg", category: "Staples", brand: "Fortune" },
            { id: 32, name: "Everest Masala (100g)", price: 95, image: "https://m.media-amazon.com/images/I/91IBlGGIvdL._SL1500_.jpg", category: "Staples", brand: "Everest" },
            
            // Personal Care
            { id: 33, name: "Colgate Toothpaste (200g)", price: 125, image: "https://images-na.ssl-images-amazon.com/images/I/81LY%2BuQBN%2BL.jpg", category: "Personal Care", brand: "Colgate" },
            { id: 34, name: "Dettol Soap (125g x 5)", price: 140, image: "https://c.scdn.gr/images/sku_main_images/024978/24978173/20200929115422_dettol_original_antibacterial_soap_5x125gr.jpeg", category: "Personal Care", brand: "Dettol" },
            { id: 35, name: "Dove Shampoo (650ml)", price: 485, image: "https://i.pinimg.com/originals/d7/f2/9b/d7f29b8647b1e8f270e3901b7918a980.jpg", category: "Personal Care", brand: "Dove" },
            { id: 36, name: "Nivea Body Lotion (400ml)", price: 295, image: "https://vedatrading.com/cdn/shop/files/Nivea_Body_Lotion.png?v=1725438727&width=1445", category: "Personal Care", brand: "Nivea" },
            
            // Household
            { id: 37, name: "Vim Dishwash Bar (300g)", price: 35, image: "https://jaihindgrocery.nl/wp-content/uploads/2022/03/61szrCRWOEL._SL1000_.jpg", category: "Household", brand: "Vim" },
            { id: 38, name: "Surf Excel Detergent (2kg)", price: 375, image: "https://m.media-amazon.com/images/I/81cnBdOlEyL._SL1500_.jpg", category: "Household", brand: "Surf Excel" },
            { id: 39, name: "Lizol Floor Cleaner (975ml)", price: 175, image: "https://m.media-amazon.com/images/I/71xgcYmOuQL._SL1500_.jpg", category: "Household", brand: "Lizol" },
            { id: 40, name: "Harpic Toilet Cleaner (500ml)", price: 115, image: "https://www.prakashsales.in/ps_assets/products/1689950803_615nYFL8CWL__SL1000_.jpg", category: "Household", brand: "Harpic" }
        ];

        // DOM elements
        const loginPage = document.getElementById('login-page');
        const registerPage = document.getElementById('register-page');
        const appContainer = document.getElementById('app-container');
        const homeView = document.getElementById('home-view');
        const orderHistoryView = document.getElementById('order-history-view');
        const profileView = document.getElementById('profile-view');
        const cartModal = document.getElementById('cart-modal');
        const checkoutModal = document.getElementById('checkout-modal');
        const passwordModal = document.getElementById('password-modal');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const heroSection = document.getElementById('hero-section');
        const daySlotsContainer = document.getElementById('day-slots-container');
        const timeSlotsContainer = document.getElementById('time-slots-container');
        const deliverySlotError = document.getElementById('delivery-slot-error');


        // Initialize app
        function init() {
            const savedUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (savedUser) {
                currentUser = savedUser;
                cart = JSON.parse(localStorage.getItem(`cart_${currentUser.id}`) || '[]');
                showApp();
            } else {
                showLogin();
            }
            setupEventListeners();
            startHeroSlideshow();
        }

        // Hero Slideshow Logic
        function changeHeroBackground() {
            currentHeroImageIndex = (currentHeroImageIndex + 1) % heroImages.length;
            const imageUrl = heroImages[currentHeroImageIndex];
            heroSection.style.backgroundImage = `linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('${imageUrl}')`;
        }

        function startHeroSlideshow() {
            currentHeroImageIndex = -1;
            changeHeroBackground();
            setInterval(changeHeroBackground, 5000);
        }

        // Event listeners
        function setupEventListeners() {
            // Auth navigation
            document.getElementById('show-register').addEventListener('click', (e) => {
                e.preventDefault();
                showRegister();
            });
            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                showLogin();
            });

            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);

            // Register form
            document.getElementById('register-form').addEventListener('submit', handleRegister);

            // Logout
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            // Navigation
            document.getElementById('home-link').addEventListener('click', (e) => {
                e.preventDefault();
                showHomeView();
                searchInput.value = '';
                document.getElementById('category-filter').value = 'all';
                currentCategory = 'all';
                renderProducts();
            });
            document.getElementById('order-history-link').addEventListener('click', (e) => {
                e.preventDefault();
                showOrderHistory();
            });
            document.getElementById('my-profile').addEventListener('click', (e) => {
                e.preventDefault();
                showProfile();
            });

            // Top Navigation Category Links
            document.querySelectorAll('.nav-links a').forEach(link => {
                if (link.id !== 'home-link') {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const categoryName = e.target.textContent.trim();
                        const filterSelect = document.getElementById('category-filter');
                        const option = Array.from(filterSelect.options).find(opt => opt.value === categoryName);
                        if (option) {
                            searchInput.value = '';
                            filterSelect.value = categoryName;
                            currentCategory = categoryName;
                            showHomeView();
                            renderProducts();
                        }
                    });
                }
            });

            // Cart Modal
            document.getElementById('cart-icon').addEventListener('click', (e) => {
                e.preventDefault();
                openCart();
            });
            document.querySelector('#cart-modal .close-modal').addEventListener('click', () => {
                cartModal.style.display = 'none';
            });
            document.getElementById('proceed-checkout-btn').addEventListener('click', openCheckout);
            document.querySelector('#checkout-modal .close-modal').addEventListener('click', () => {
                checkoutModal.style.display = 'none';
            });
            document.getElementById('edit-address-btn').addEventListener('click', () => {
                checkoutModal.style.display = 'none';
                showProfile();
            });
            document.getElementById('place-order-btn').addEventListener('click', placeOrder);

            // Profile
            document.getElementById('profile-form').addEventListener('submit', updateProfile);
            document.getElementById('change-password-btn').addEventListener('click', () => {
                passwordModal.style.display = 'flex';
                document.getElementById('change-password-form').reset();
                hideError('password-error');
                hideSuccess('password-success');
            });
            document.getElementById('change-password-form').addEventListener('submit', changePassword);
            document.getElementById('delete-account-btn').addEventListener('click', deleteAccount);
            
            // Payment methods
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedPaymentMethod = this.getAttribute('data-method');

                    // Show/hide payment details based on selection
                    document.getElementById('card-payment-details').style.display = 'none';
                    document.getElementById('upi-payment-details').style.display = 'none';
                    if (selectedPaymentMethod === 'card') {
                        document.getElementById('card-payment-details').style.display = 'block';
                    } else if (selectedPaymentMethod === 'upi') {
                        document.getElementById('upi-payment-details').style.display = 'block';
                    }
                });
            });

            // UPI app selection
            document.querySelectorAll('.upi-app').forEach(app => {
                app.addEventListener('click', function() {
                    document.querySelectorAll('.upi-app').forEach(a => a.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedUpiApp = this.getAttribute('data-app');
                });
            });

            // Card number formatting
            document.getElementById('card-number').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
            });
            
            // Card expiry formatting
            document.getElementById('card-expiry').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.slice(0, 2) + '/' + value.slice(2, 4);
                }
                e.target.value = value;
            });
            
            // CVV - numbers only
            document.getElementById('card-cvv').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '');
            });

            // Product actions
            document.getElementById('products-container').addEventListener('click', handleProductActions);
            document.getElementById('cart-items').addEventListener('click', handleCartActions);

            // Category filter
            document.getElementById('category-filter').addEventListener('change', (e) => {
                currentCategory = e.target.value;
                searchInput.value = '';
                renderProducts();
            });
            
            // Search
            searchButton.addEventListener('click', () => {
                const searchTerm = searchInput.value.toLowerCase();
                if (searchTerm) {
                    const filteredProducts = products.filter(p => 
                        p.name.toLowerCase().includes(searchTerm) || 
                        p.category.toLowerCase().includes(searchTerm) ||
                        p.brand.toLowerCase().includes(searchTerm)
                    );
                    currentCategory = 'search'; // Indicate search results are shown
                    renderProducts(filteredProducts);
                    showHomeView();
                    document.getElementById('category-filter').value = 'all'; // Reset filter selection
                } else {
                    currentCategory = 'all';
                    renderProducts();
                }
            });

            // Close modals on outside click
            window.addEventListener('click', (e) => {
                if (e.target === cartModal) cartModal.style.display = 'none';
                if (e.target === checkoutModal) checkoutModal.style.display = 'none';
                if (e.target === passwordModal) passwordModal.style.display = 'none';
            });
            document.getElementById('close-password-modal').addEventListener('click', () => {
                passwordModal.style.display = 'none';
            });
            
            // Delivery Slot Selection Listeners
            daySlotsContainer.addEventListener('click', handleDaySlotClick);
            timeSlotsContainer.addEventListener('click', handleTimeSlotClick);
        }

        // --- Auth Functions ---
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            const users = JSON.parse(localStorage.getItem('groceryUsers') || '[]');
            const user = users.find(u => u.email === email && u.password === password);

            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                cart = JSON.parse(localStorage.getItem(`cart_${currentUser.id}`) || '[]');
                showApp();
            } else {
                showError('login-error', 'Invalid email or password.');
            }
        }

        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const phone = document.getElementById('register-phone').value.trim();
            const address = document.getElementById('register-address').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;

            if (password !== confirmPassword) {
                showError('register-error', 'Passwords do not match.');
                return;
            }

            const users = JSON.parse(localStorage.getItem('groceryUsers') || '[]');
            if (users.find(u => u.email === email)) {
                showError('register-error', 'An account with this email already exists. Please login.');
                return;
            }

            const newUser = { id: Date.now(), name, email, phone, address, password };
            users.push(newUser);
            localStorage.setItem('groceryUsers', JSON.stringify(users));

            showSuccess('register-success', 'Account created successfully! Redirecting to login...');
            setTimeout(() => {
                showLogin();
            }, 2000);
        }

        function handleLogout(e) {
            e.preventDefault();
            localStorage.setItem(`cart_${currentUser.id}`, JSON.stringify(cart));
            currentUser = null;
            cart = [];
            localStorage.removeItem('currentUser');
            showLogin();
        }

        // --- View management ---
        function showLogin() {
            loginPage.style.display = 'flex';
            registerPage.style.display = 'none';
            appContainer.style.display = 'none';
            document.getElementById('login-form').reset();
            hideError('login-error');
        }

        function showRegister() {
            loginPage.style.display = 'none';
            registerPage.style.display = 'flex';
            appContainer.style.display = 'none';
            document.getElementById('register-form').reset();
            hideError('register-error');
            hideSuccess('register-success');
        }

        function showApp() {
            loginPage.style.display = 'none';
            registerPage.style.display = 'none';
            appContainer.style.display = 'block';
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=2ecc71&color=fff`;
            showHomeView();
            renderProducts();
            updateCartCount();
        }

        function showHomeView() {
            homeView.style.display = 'block';
            orderHistoryView.style.display = 'none';
            profileView.style.display = 'none';
        }

        function showOrderHistory() {
            homeView.style.display = 'none';
            orderHistoryView.style.display = 'block';
            profileView.style.display = 'none';
            renderOrderHistory();
        }

        function showProfile() {
            homeView.style.display = 'none';
            orderHistoryView.style.display = 'none';
            profileView.style.display = 'block';
            loadProfileData();
        }

        // --- Product functions (omitted for brevity) ---
        function renderProducts(productsToRender = null) {
            const container = document.getElementById('products-container');
            container.innerHTML = '';

            let displayedProducts = productsToRender;
            if (displayedProducts === null) {
                displayedProducts = currentCategory === 'all' ? products : products.filter(p => p.category === currentCategory);
            }

            if (displayedProducts.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; font-size: 18px; color: var(--gray);">No products found in this category.</p>';
                return;
            }

            displayedProducts.forEach(product => {
                const cartItem = cart.find(item => item.id === product.id);
                const quantity = cartItem ? cartItem.quantity : 0;
                
                const productEl = document.createElement('div');
                productEl.className = 'product';
                productEl.innerHTML = `
                    <div class="product-img" style="background-image: url('${product.image}')"></div>
                    <div class="product-info">
                        <div class="product-title">${product.name}</div>
                        <div class="product-price">${product.price}</div>
                        <small style="color: var(--gray);">${product.category} | ${product.brand}</small>
                        <div class="product-actions" style="margin-top: 15px;">
                            ${quantity === 0 
                                ? `<button class="add-to-cart" data-id="${product.id}">Add to Cart</button>` 
                                : `
                                <div class="quantity">
                                    <button class="decrease" data-id="${product.id}">-</button>
                                    <span>${quantity}</span>
                                    <button class="increase" data-id="${product.id}">+</button>
                                </div>
                                <button class="add-to-cart" data-id="${product.id}" style="background: var(--primary-dark); padding: 8px 10px;">
                                    <i class="fas fa-check"></i> Added
                                </button>
                                `
                            }
                        </div>
                    </div>
                `;
                container.appendChild(productEl);
            });
        }
        // --- End Product functions ---

        // --- Cart Logic (omitted for brevity) ---
        function saveCart() {
            if (currentUser) {
                localStorage.setItem(`cart_${currentUser.id}`, JSON.stringify(cart));
            }
        }

        function updateCartCount() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.querySelector('.cart-count').textContent = count;
        }

        function handleProductActions(e) {
            const target = e.target.closest('button');
            if (!target) return;

            const productId = parseInt(target.getAttribute('data-id'));
            
            if (target.classList.contains('add-to-cart')) {
                addToCart(productId);
            } else if (target.classList.contains('increase')) {
                increaseQuantity(productId);
            } else if (target.classList.contains('decrease')) {
                decreaseQuantity(productId);
            }
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...product, quantity: 1 });
            }

            saveCart();
            updateCartCount();
            renderProducts();
        }

        function increaseQuantity(productId) {
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                cartItem.quantity += 1;
            } else {
                addToCart(productId);
                return;
            }
            saveCart();
            updateCartCount();
            renderProducts();
            renderCartItems();
        }

        function decreaseQuantity(productId) {
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                cartItem.quantity -= 1;
                if (cartItem.quantity <= 0) {
                    cart = cart.filter(item => item.id !== productId);
                }
            }
            saveCart();
            updateCartCount();
            renderProducts();
            renderCartItems();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            saveCart();
            updateCartCount();
            renderProducts();
            renderCartItems();
        }

        function openCart() {
            cartModal.style.display = 'flex';
            renderCartItems();
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';

            if (cart.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">Your cart is empty</p>';
                updateCartSummary(0);
                return;
            }

            let subtotal = 0;
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                const cartItemEl = document.createElement('div');
                cartItemEl.className = 'cart-item';
                cartItemEl.innerHTML = `
                    <div class="cart-item-img" style="background-image: url('${item.image}')"></div>
                    <div class="cart-item-details">
                        <div class="cart-item-title">${item.name}</div>
                        <div class="cart-item-price">${item.price}</div>
                    </div>
                    <div class="cart-item-actions">
                        <button class="decrease" data-id="${item.id}">-</button>
                        <span>${item.quantity}</span>
                        <button class="increase" data-id="${item.id}">+</button>
                        <button class="remove-item" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(cartItemEl);
            });

            updateCartSummary(subtotal);
        }

        function handleCartActions(e) {
            const target = e.target.closest('button');
            if (!target) return;

            const productId = parseInt(target.getAttribute('data-id'));

            if (target.classList.contains('increase')) {
                increaseQuantity(productId);
            } else if (target.classList.contains('decrease')) {
                decreaseQuantity(productId);
            } else if (target.classList.contains('remove-item')) {
                removeFromCart(productId);
            }
        }

        function updateCartSummary(subtotal) {
            const deliveryFee = 40;
            const total = subtotal + deliveryFee;

            document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('delivery-fee').textContent = `₹${deliveryFee.toFixed(2)}`;
            document.getElementById('total').textContent = `₹${total.toFixed(2)}`;
            
            document.getElementById('checkout-subtotal').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('checkout-delivery').textContent = `₹${deliveryFee.toFixed(2)}`;
            document.getElementById('checkout-total').textContent = `₹${total.toFixed(2)}`;
            
            document.getElementById('proceed-checkout-btn').disabled = cart.length === 0;
            document.getElementById('place-order-btn').disabled = cart.length === 0;
        }
        // --- End Cart Logic ---


        // --- Delivery Slot Selection Functions ---

        function getNextSevenDays() {
            const days = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() + i);
                
                const isToday = i === 0;
                const dateKey = date.toISOString().split('T')[0];
                const dayName = isToday ? 'Today' : date.toLocaleDateString('en-IN', { weekday: 'short' });
                const dateFormatted = date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });

                days.push({
                    key: dateKey,
                    label: dayName,
                    date: dateFormatted
                });
            }
            return days;
        }

        function renderDaySlots() {
            daySlotsContainer.innerHTML = '';
            const days = getNextSevenDays();

            days.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = `slot-day-item`;
                dayEl.setAttribute('data-day-key', day.key);
                dayEl.innerHTML = `
                    <p>${day.label}</p>
                    <small style="color: var(--gray);">${day.date}</small>
                `;
                daySlotsContainer.appendChild(dayEl);
            });
            // Reset slot selections when days are rendered
            selectedDeliveryDate = null;
            selectedTimeSlot = null;
            renderTimeSlots();
            hideError('delivery-slot-error');
        }

        function renderTimeSlots() {
            timeSlotsContainer.innerHTML = '';
            
            if (!selectedDeliveryDate) {
                timeSlotsContainer.innerHTML = '<p style="font-size: 14px; color: var(--gray);">Please select a delivery day first.</p>';
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const isToday = selectedDeliveryDate === today;
            const currentHour = new Date().getHours();
            
            timeSlots.forEach(slot => {
                // Disable slot if it's today and the slot has already passed
                const isDisabled = isToday && currentHour >= slot.endHour;
                
                const timeEl = document.createElement('div');
                timeEl.className = `slot-time-item ${isDisabled ? 'disabled' : ''}`;
                timeEl.setAttribute('data-slot-id', slot.id);
                timeEl.setAttribute('data-slot-time', slot.time);
                timeEl.setAttribute('data-start-hour', slot.startHour);
                
                timeEl.innerHTML = `
                    <p>${slot.name}</p>
                    <small>(${slot.time})</small>
                `;
                timeSlotsContainer.appendChild(timeEl);
            });
            
            // Re-select the time slot if available and previously selected
            if (selectedTimeSlot) {
                const previouslySelectedEl = timeSlotsContainer.querySelector(`[data-slot-id="${selectedTimeSlot.id}"]`);
                if (previouslySelectedEl && !previouslySelectedEl.classList.contains('disabled')) {
                    previouslySelectedEl.classList.add('selected');
                } else {
                    selectedTimeSlot = null;
                }
            }
            hideError('delivery-slot-error');
        }

        function handleDaySlotClick(e) {
            const target = e.target.closest('.slot-day-item');
            if (!target) return;
            
            document.querySelectorAll('.slot-day-item').forEach(el => el.classList.remove('selected'));
            target.classList.add('selected');

            selectedDeliveryDate = target.getAttribute('data-day-key');
            selectedTimeSlot = null; // Clear time slot selection upon day change
            renderTimeSlots();
        }

        function handleTimeSlotClick(e) {
            const target = e.target.closest('.slot-time-item');
            if (!target || target.classList.contains('disabled')) return;
            
            document.querySelectorAll('.slot-time-item').forEach(el => el.classList.remove('selected'));
            target.classList.add('selected');

            const slotId = target.getAttribute('data-slot-id');
            selectedTimeSlot = timeSlots.find(slot => slot.id === slotId);
            hideError('delivery-slot-error');
        }

        // --- Checkout & Order ---
        
        // Function to calculate final delivery timestamp
        function calculateFinalDeliveryTime() {
            if (!selectedDeliveryDate || !selectedTimeSlot) {
                return null;
            }

            // Start with the selected day
            const selectedDay = new Date(selectedDeliveryDate);

            // Set the time to the beginning of the selected time slot
            selectedDay.setHours(selectedTimeSlot.startHour, 0, 0, 0);

            // The delivery is promised within 10 minutes of the start of the slot.
            // For simplicity, we'll record the start time + 10 mins as the ETA (Expected Time of Arrival).
            selectedDay.setMinutes(selectedDay.getMinutes() + 10);

            // The formatted string for order display
            const formattedTime = `${selectedTimeSlot.name} (${selectedTimeSlot.time})`;
            
            return {
                timestamp: selectedDay.toISOString(),
                formattedSlot: formattedTime
            };
        }
        
        function openCheckout() {
            if (cart.length === 0) {
                alert('Your cart is empty. Please add items before checking out.');
                return;
            }

            // Reset selection upon opening, only keep current profile details
            selectedDeliveryDate = null;
            selectedTimeSlot = null;
            
            // Load delivery selection elements
            renderDaySlots();
            
            // Load address info
            document.getElementById('checkout-name').textContent = currentUser.name;
            document.getElementById('checkout-phone').textContent = currentUser.phone;
            document.getElementById('checkout-address').textContent = currentUser.address;
            
            // Reset payment selection/details
            selectedPaymentMethod = null;
            selectedUpiApp = null;
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
            document.querySelectorAll('.upi-app').forEach(a => a.classList.remove('selected'));
            document.getElementById('card-payment-details').style.display = 'none';
            document.getElementById('upi-payment-details').style.display = 'none';
            document.getElementById('card-number').value = '';
            document.getElementById('card-name').value = '';
            document.getElementById('card-expiry').value = '';
            document.getElementById('card-cvv').value = '';
            document.getElementById('upi-id').value = '';

            hideError('delivery-slot-error');
            cartModal.style.display = 'none';
            checkoutModal.style.display = 'flex';
        }

        function placeOrder() {
            // 1. Validate Delivery Slot
            if (!selectedDeliveryDate || !selectedTimeSlot) {
                showError('delivery-slot-error', 'Please select a delivery day and time slot.');
                return;
            }
            hideError('delivery-slot-error');
            
            const finalDeliveryTime = calculateFinalDeliveryTime();
            if (!finalDeliveryTime) return; // Should not happen if previous checks pass

            // 2. Validate Payment Method
            if (!selectedPaymentMethod) {
                alert('Please select a payment method!');
                return;
            }
            
            // 3. Validate Payment Details (omitted boilerplate for brevity)
            // ... (rest of payment validation logic)
            if (selectedPaymentMethod === 'card') {
                const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
                const cardName = document.getElementById('card-name').value.trim();
                const cardExpiry = document.getElementById('card-expiry').value;
                const cardCvv = document.getElementById('card-cvv').value;
                if (!cardNumber || cardNumber.length < 16) { alert('Please enter a valid 16-digit card number!'); return; }
                if (!cardName) { alert('Please enter the cardholder name!'); return; }
                if (!cardExpiry || cardExpiry.length !== 5 || parseInt(cardExpiry.split('/')[0]) < 1 || parseInt(cardExpiry.split('/')[0]) > 12) { alert('Please enter a valid expiry date (MM/YY)!'); return; }
                const [month, year] = cardExpiry.split('/');
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear() % 100;
                const currentMonth = currentDate.getMonth() + 1;
                if (parseInt(year) < currentYear || (parseInt(year) === currentYear && parseInt(month) < currentMonth)) { alert('Card has expired! Please check the expiry date.'); return; }
                if (!cardCvv || cardCvv.length !== 3) { alert('Please enter a valid 3-digit CVV!'); return; }
            }
            
            if (selectedPaymentMethod === 'upi') {
                const upiId = document.getElementById('upi-id').value.trim();
                if (!selectedUpiApp && !upiId) { alert('Please select a UPI app or enter your UPI ID!'); return; }
                if (upiId && !upiId.includes('@')) { alert('Please enter a valid UPI ID (e.g., username@upi)!'); return; }
            }
            // ... End payment validation logic

            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const deliveryFee = 40;
            const total = subtotal + deliveryFee;

            // Prepare payment details
            let paymentDetails = selectedPaymentMethod;
            if (selectedPaymentMethod === 'card') paymentDetails = 'Credit/Debit Card (****' + document.getElementById('card-number').value.replace(/\s/g, '').slice(-4) + ')';
            if (selectedPaymentMethod === 'upi') paymentDetails = selectedUpiApp ? selectedUpiApp.toUpperCase() : document.getElementById('upi-id').value.trim();
            if (selectedPaymentMethod === 'cod') paymentDetails = 'Cash on Delivery';

            const order = {
                id: Date.now().toString().slice(-6),
                userId: currentUser.id,
                date: new Date().toISOString(),
                items: JSON.parse(JSON.stringify(cart)), 
                subtotal: subtotal,
                deliveryFee: deliveryFee,
                total: total,
                status: 'Processing',
                paymentMethod: selectedPaymentMethod,
                paymentDetails: paymentDetails,
                shippingAddress: currentUser.address,
                // Store the calculated delivery time (start of slot + 10 mins)
                deliveryTime: finalDeliveryTime.timestamp,
                deliverySlot: finalDeliveryTime.formattedSlot,
                deliveryDayKey: selectedDeliveryDate
            };

            // Save order
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));

            // Clear cart
            cart = [];
            saveCart();
            updateCartCount();

            // Clear slot selection
            selectedDeliveryDate = null;
            selectedTimeSlot = null;

            // Close modal and show success
            checkoutModal.style.display = 'none';
            alert(`Order placed successfully! Order ID: ${order.id}\nPayment: ${paymentDetails}\nExpected Delivery: ${order.deliverySlot}`);
            showOrderHistory();
        }

        // Order history functions
        function renderOrderHistory() {
            const container = document.getElementById('orders-container');
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const userOrders = orders.filter(order => order.userId === currentUser.id).reverse();

            if (userOrders.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px;">No orders yet</p>';
                return;
            }

            container.innerHTML = '';
            userOrders.forEach(order => {
                const orderDate = new Date(order.date);
                const statusClass = order.status.toLowerCase().replace(' ', '-');
                
                const deliveryDateObj = order.deliveryTime ? new Date(order.deliveryTime) : null;
                
                // Use the stored slot/key to display the delivery information
                const deliveryDayLabel = deliveryDateObj ? deliveryDateObj.toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'short' }) : 'N/A';
                const deliverySlotText = order.deliverySlot || 'N/A';
                
                const orderEl = document.createElement('div');
                orderEl.className = 'order-card';
                orderEl.innerHTML = `
                    <div class="order-header">
                        <div>
                            <div class="order-id">Order #${order.id}</div>
                            <small>${orderDate.toLocaleDateString()} ${orderDate.toLocaleTimeString()}</small>
                            <!-- Display Scheduled Delivery Slot -->
                            <div class="order-delivery-time">
                                <i class="fas fa-calendar-alt"></i> Delivery Day: ${deliveryDayLabel}
                            </div>
                            <div class="order-delivery-time" style="color: var(--warning);">
                                <i class="fas fa-clock"></i> Delivery Slot: ${deliverySlotText} (Expected arrival within 10 mins of slot start)
                            </div>
                        </div>
                        <span class="order-status status-${statusClass}">${order.status}</span>
                    </div>
                    <div class="order-items">
                        ${order.items.map(item => `
                            <div class="order-item">
                                <span>${item.name} x ${item.quantity}</span>
                                <span>₹${(item.price * item.quantity).toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="order-footer">
                        <div>
                            <strong>Total: ₹${order.total.toFixed(2)}</strong><br>
                            <small>Payment: ${order.paymentDetails || getPaymentMethodName(order.paymentMethod)}</small>
                        </div>
                        <button class="download-invoice-btn" data-order-id="${order.id}">
                            <i class="fas fa-download"></i> Download Invoice
                        </button>
                    </div>
                `;
                container.appendChild(orderEl);
            });

            // Add event listeners for invoice download
            container.querySelectorAll('.download-invoice-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-order-id');
                    downloadInvoice(orderId);
                });
            });
        }

        function getPaymentMethodName(method) {
            switch (method) {
                case 'cod': return 'Cash on Delivery';
                case 'card': return 'Credit/Debit Card';
                case 'upi': return 'UPI / Netbanking';
                default: return 'N/A';
            }
        }

        function downloadInvoice(orderId) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const order = orders.find(o => o.id === orderId);

            if (!order) {
                alert('Order not found!');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Fetch user details for the invoice
            const users = JSON.parse(localStorage.getItem('groceryUsers') || '[]');
            const user = users.find(u => u.id === order.userId);
            if (!user) {
                 alert('User data not found!'); 
                 return;
            }

            // Header
            doc.setFontSize(22);
            doc.setTextColor(46, 204, 113); // Primary color
            doc.text('FreshBasket', 105, 20, { align: 'center' });
            doc.setFontSize(10);
            doc.setTextColor(50, 50, 50);
            doc.text('Invoice', 105, 26, { align: 'center' });
            
            // Horizontal line
            doc.setLineWidth(0.5);
            doc.setDrawColor(46, 204, 113);
            doc.line(20, 30, 190, 30);

            // Invoice Details
            doc.setFontSize(10);
            doc.setTextColor(50, 50, 50);
            let yPos = 35;
            
            doc.setFont(undefined, 'bold');
            doc.text('INVOICE TO:', 20, yPos);
            doc.text('INVOICE DETAILS:', 120, yPos);
            yPos += 5;

            doc.setFont(undefined, 'normal');
            doc.text(user.name, 20, yPos); 
            doc.text(`Invoice No: ${order.id}`, 120, yPos);
            yPos += 5;
            doc.text(user.address.substring(0, 50) + '...', 20, yPos); 
            doc.text(`Order Date: ${new Date(order.date).toLocaleDateString()}`, 120, yPos);
            yPos += 5;
            
            doc.text(`Email: ${user.email}`, 20, yPos); 
            doc.text(`Status: ${order.status}`, 120, yPos);
            yPos += 5;

            doc.text(`Phone: ${user.phone}`, 20, yPos);
            
            // Add Delivery Slot details
            const deliveryDateObj = order.deliveryTime ? new Date(order.deliveryTime) : null;
            const deliveryDayLabel = deliveryDateObj ? deliveryDateObj.toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'short' }) : 'N/A';
            doc.text(`Delivery Day: ${deliveryDayLabel}`, 120, yPos);
            yPos += 5;
            doc.text(`Delivery Slot: ${order.deliverySlot}`, 120, yPos);
            yPos += 5;
            doc.text(`Est. Arrival: ${deliveryDateObj ? deliveryDateObj.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }) : 'N/A'}`, 120, yPos);
            // End Delivery Slot details

            yPos += 15;
            
            // Table Header
            doc.setDrawColor(200, 200, 200);
            doc.setFillColor(230, 230, 230);
            doc.rect(20, yPos, 170, 8, 'F');
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(50, 50, 50);
            doc.text('Item Description', 25, yPos + 5);
            doc.text('Qty', 120, yPos + 5);
            doc.text('Price/Unit', 145, yPos + 5);
            doc.text('Total', 170, yPos + 5);

            // Table items
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            yPos += 12;
            order.items.forEach(item => {
                doc.text(item.name, 25, yPos);
                doc.text(item.quantity.toString(), 120, yPos);
                doc.text(`Rs. ${item.price.toFixed(2)}`, 145, yPos); 
                doc.text(`Rs. ${(item.price * item.quantity).toFixed(2)}`, 170, yPos); 
                yPos += 7;
            });

            // Summary divider
            yPos += 5;
            doc.line(20, yPos, 190, yPos);
            
            // Subtotal, Delivery Fee
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Subtotal:', 150, yPos + 10);
            doc.text(`Rs. ${order.subtotal.toFixed(2)}`, 170, yPos + 10); 
            yPos += 7;
            doc.text('Delivery Fee:', 150, yPos + 10);
            doc.text(`Rs. ${order.deliveryFee.toFixed(2)}`, 170, yPos + 10); 
            yPos += 12;

            // Total Amount
            doc.setDrawColor(46, 204, 113);
            doc.setFillColor(220, 247, 228);
            doc.rect(138, yPos + 5, 52, 7, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('TOTAL AMOUNT:', 140, yPos + 10);
            doc.setFontSize(12);
            doc.setTextColor(46, 204, 113); // Primary color
            doc.text(`Rs. ${order.total.toFixed(2)}`, 170, yPos + 10); 
            
            // Payment method
            yPos += 10;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            doc.setTextColor(50, 50, 50);
            doc.text(`Payment Method: ${order.paymentDetails || getPaymentMethodName(order.paymentMethod)}`, 20, yPos);
            
            // Footer
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text('Thank you for shopping with FreshBasket!', 105, 280, { align: 'center' });
            
            // Save PDF
            doc.save(`Invoice_${order.id}.pdf`);
        }

        // Utility functions (omitted boilerplate for brevity)
        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function hideError(elementId) {
            const errorEl = document.getElementById(elementId);
            errorEl.style.display = 'none';
        }

        function showSuccess(elementId, message) {
            const successEl = document.getElementById(elementId);
            successEl.textContent = message;
            successEl.style.display = 'block';
        }

        function hideSuccess(elementId) {
            const successEl = document.getElementById(elementId);
            successEl.style.display = 'none';
        }

        // --- Profile Management (omitted boilerplate for brevity) ---
        function loadProfileData() {
            if (currentUser) {
                document.getElementById('profile-name').value = currentUser.name;
                document.getElementById('profile-email').value = currentUser.email;
                document.getElementById('profile-phone').value = currentUser.phone;
                document.getElementById('profile-address').value = currentUser.address;
                hideError('profile-error');
                hideSuccess('profile-success');
            }
        }

        function updateProfile(e) {
            e.preventDefault();
            const name = document.getElementById('profile-name').value.trim();
            const phone = document.getElementById('profile-phone').value.trim();
            const address = document.getElementById('profile-address').value.trim();

            if (!name || !phone || !address) {
                showError('profile-error', 'All fields are required.');
                return;
            }

            currentUser.name = name;
            currentUser.phone = phone;
            currentUser.address = address;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            let users = JSON.parse(localStorage.getItem('groceryUsers') || '[]');
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('groceryUsers', JSON.stringify(users));
            }

            showSuccess('profile-success', 'Profile updated successfully!');
            document.getElementById('user-name').textContent = currentUser.name;
        }

        function changePassword(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;

            hideError('password-error');
            hideSuccess('password-success');

            if (currentPassword !== currentUser.password) {
                showError('password-error', 'Current password is incorrect.');
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('password-error', 'New passwords do not match.');
                return;
            }

            currentUser.password = newPassword;
            
            const users = JSON.parse(localStorage.getItem('groceryUsers') || '[]');
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('groceryUsers', JSON.stringify(users));
            }

            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            showSuccess('password-success', 'Password changed successfully!');
            setTimeout(() => {
                passwordModal.style.display = 'none';
                document.getElementById('change-password-form').reset();
            }, 2000);
        }

        function deleteAccount() {
            const confirmed = confirm('Are you sure you want to delete your account? This action cannot be undone. All your orders and data will be permanently deleted.');
            if (!confirmed) return;

            const doubleConfirm = confirm('This is your last chance! Are you absolutely sure you want to delete your account?');
            if (!doubleConfirm) return;

            let users = JSON.parse(localStorage.getItem('groceryUsers') || '[]');
            users = users.filter(u => u.id !== currentUser.id);
            localStorage.setItem('groceryUsers', JSON.stringify(users));

            localStorage.removeItem(`cart_${currentUser.id}`);

            let orders = JSON.parse(localStorage.getItem('orders') || '[]');
            orders = orders.filter(order => order.userId !== currentUser.id);
            localStorage.setItem('orders', JSON.stringify(orders));

            localStorage.removeItem('currentUser');
            currentUser = null;
            cart = [];

            alert('Your account has been permanently deleted.');
            showLogin();
        }


        // Start the application
        init();
    </script>
</body>
</html>